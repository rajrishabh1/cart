<?php

class Cr extends Controller{
    public function index(){
        $User = $this->load_model('User');
        $user_data = $User->check_login();
        

        $db = new  Database();
        $dtb =  Idatabase::getInstance();
        $dbName1 = $db->getDbName();
        $dbName2 = $dtb->getDb_Name();
        if (isset($_SESSION['cuid'])) {
        //Showing data if user is logged in
        $cuid = $_SESSION['cuid'];

        $sql = "SELECT ci.id, ci.puid, ci.qty AS qty, p.pd_title AS `title`, p.pd_mrp AS `mrp`, p.pd_yourprice AS `sellingPrice`,
        pi.pd_quantity AS `quantity`, i.image
        FROM {$dbName1}.cart_items AS ci
        INNER JOIN cart AS c ON ci.cart_id = c.id
        INNER JOIN {$dbName1}.products AS p ON ci.puid = p.puid
        INNER JOIN {$dbName1}.products_inventory AS pi ON p.puid = pi.puid
        INNER JOIN {$dbName2}.pd_images AS i ON p.puid = i.puid
        WHERE c.cuid = :cuid AND ci.status = :status
        GROUP BY ci.puid;";

        $data = array(':cuid' => $cuid, ':status' => 1);
        // Use prepared statements to prevent SQL injection
        $result = $db->read($sql, $data);
        $cartDisplayResult = $this->cart_Display($result);
        $data['cartItems'] = $cartDisplayResult;

        unset($_SESSION["cart"]);
    } else {
       // User is not logged in
       $cartItems = isset($_SESSION["cart"]) ? $_SESSION["cart"] : array();
       $result = array();

       foreach ($cartItems as $puid => $item) {
           $sql = "SELECT p.pd_title AS `title`, p.pd_mrp AS `mrp`, p.pd_yourprice AS `sellingPrice`, 
           i.pd_quantity AS `quantity`, img.image
           FROM {$dbName1}.products p
           LEFT JOIN {$dbName1}.products_inventory i ON p.puid = i.puid
           LEFT JOIN {$dbName2}.pd_images img ON p.puid = img.puid
           WHERE p.puid = :puid AND p.status= :status
           GROUP BY p.puid;";

           $data = array(':puid' => $puid, ':status' => 1);
           // Get product details from database
           $productDetails = $db->read($sql, $data);

           if ($productDetails) {
               // Add quantity and puid from session cart to product details
               $productDetails[0]->qty = $item["qty"];
               $productDetails[0]->puid = $puid;
               $result[] = $productDetails[0];
           }
       }

       $cartDisplayResult = $this->cart_Display($result);
       $data['cartItems'] = $cartDisplayResult;
   }



        $data['page_title'] = "Cart";
        $this->view("cr",$data);
    }
    //Add Cart
    public function addCart()
    {
        if (isset($_POST['csrf_token']) && $_POST['csrf_token'] == $_SESSION['csrf_token']) {
            $addTocart = $this->load_model("cart");
            $result = $addTocart->cart($_POST);

            //echo json_encode($result);
            if ($result) {
                echo json_encode(array("success" => "Added to cart"));
            } else {
                echo json_encode(array("success" => $_SESSION['success'], "error" => $_SESSION['error']));
            }
        } else {
            echo json_encode(array("success" => false, "error" => "Invalid CSRF token"));
        }
    }

public function cartCount()
{
    if (isset($_SESSION['cuid'])) {
        // User is logged in
        $countCart = $this->load_model("cart");
        $result = $countCart->getCartItems(); // Pass the customer's cuid

        if (isset($result['error'])) {
            echo json_encode(array("success" => false, "error" => $result['error']));
        } else {
            $cartItems = array();

            foreach ($result as $item) {
                // Extract puid and qty for each cart item
                $id = $item->id;

                // For example, add them to an array or display them
                $cartItems[] = array("rid" => $id);
            }

            // You can use $cartItems for further processing or display
            echo json_encode(array("success" => "Added to cart", "cartItems" => $cartItems));
        }
    } else {
        // User is not logged in
        $cartCount = isset($_SESSION["cart"]) ? count($_SESSION["cart"]) : 0;

        echo json_encode(array("success" => "Cart count fetched successfully", "cartCount" => $cartCount));
    }
}


function cart_Display($result){
    require_once 'app/libs/cryptor.class.php';
    $crypt = new Cryptor(); 
    $output = '';

    if (is_array($result) && count($result) > 0) {

        $output .= '<div class="row cart-detail-container m-0">
        <div class="col-md-8  cart-detail-content-left">
        <div class="row cart-detail-content-left-container m-0">
            <!--------------->
            <div class="col-md-12 cart-detail-content-left-content-order-added ">
                <div class="row crtOrder-top m-0">
                    <header><span class="sbBkD">Shopping Cart</span>
                    </header>
                    <div class="col-md-12 crt-container">';
        foreach ($result as $item) {
       
            $mrp = $item->mrp;
            // Check if the number has decimal places
            if (is_numeric($mrp) && floor($mrp) != $mrp) {
                // If it has decimal places, format it with two decimal places
                $formattedMrp = number_format($mrp, 2);
            } else {
                // If it's an integer, format it without decimal places
                $formattedMrp = number_format($mrp, 0);
            }
            $yourPrice = $item->sellingPrice;
            // Check if the number has decimal places
            if (is_numeric($yourPrice) && floor($yourPrice) != $yourPrice) {
                // If it has decimal places, format it with two decimal places
                $formattedPrice = number_format($yourPrice, 2);
            } else {
                // If it's an integer, format it without decimal places
                $formattedPrice = number_format($yourPrice, 0);
            }
            //Total quantity added in cart of an item
            $itemQty = $item->qty;
            $encryptedID = $crypt->encryptId($item->puid);
        

            $output .=  '<!---------->
                            <div class="row cart-Item m-0">
                                <div class="iput-checkbx-crt-sel-con">
                                    <input type="checkbox" name="itm" id="cartItmSelct">
                                </div>
                                <div class="cart-img-fLMI">
                                    <div class="cart-img-InBG"
                                        style="background-image: url(&quot;'.IMAGES.$item->image.'&quot;), url(&quot;'.MISCELLANEOUS.'default.jpg&quot;);">
                                    </div>
                                </div>
                                <div class="cart-bdy-fLMI">
                                    <header class="m-0 p-0">
                                        <span class="ZUk1ciD m-0 p-0"><a href="' . BASEURL . 'pd?p='.$encryptedID.'">'.$item->title.'</a></span>
                                        <span class="crt-bdy2-fLMI">
                                            <span class="zTqR3Sp"><span class="left-lftQa">Order Delivery by
                                                </span><span class="dlOnD">Tuesday,10 Oct</span></span>
                                        </span>
                                    </header>
                                    <div class="crtprc">
                                        <span class="oldprcCrt">₹'.$formattedMrp.'</span>
                                        <span class="newprCrt">₹'.$formattedPrice.'</span>
                                    </div>
                                    <div class="crt-slr">
                                        <span class="lft">Sold by :</span>
                                        <span class="crt-slrNm">Miraan</span>
                                    </div>';
                                 if ($item->quantity > 0) {
                                    $output .=  '<div class="instk01">
                                                    <span class="c_08utrt">In stock</span>
                                                </div>';
                                 }else{
                                    $output .=  '<div class="instk01">
                                                    <span class="c_08utrt" style="color: #EA2027;">Out of stock</span>
                                                </div>
                                                ';
                                 }
                                 $output .=  '<div class="crt-qty">
                                        <div class="left">Qty:</div>
                                        <div class="crt-sum-con">
                                            <button id="decrement" onclick="stepper(this)"> - </button>
                                            <input type="number" value="'.$itemQty.'" id="qtyInput" min="1" max="100" step="1"
                                                readonly />
                                            <button id="increment" onclick="stepper(this)"> + </button>
                                        </div>
                                    </div>
                                    <div class="remove-itm-crt">
                                        <a class="ItmRbtnsQ" href="#">Remove Item</a>
                                    </div>
                                </div>
                            </div>
                            <!---------->';
                        
         }
        $output .='</div>
                    </div>
                </div>
                <!--------------->
            </div>
        </div>
        <!------------>
        <div class="col-md-4 cart-detail-content-right">
            <div class="chkDCR-bxs">
                <header>YOUR ORDER</header>
                <!-------->
                <hr class="chk-hr">
                <div class="row cart-bottom">
                    <div class="cart-bottom-0"><span class="crt-itm-lft">Item</span><span
                            class="crt-itm-rht">2</span></div>
                    <div class="cart-bottom-1"><span class="crt-delC-lft">Delivery</span><span
                            class="crt-delC-rht">Rs40</span></div>
                    <div class="cart-bottom-2"><span class="crt-dsc-lft">Discount</span><span
                            class="crt-dsc-rht">-Rs10</span></div>
                    <hr class="chk-hr2">
                    <div class="cart-bottom-3"><span class="crt-ttl-lft">Total</span><span
                            class="crt-ttl-rht">Rs'.$itemQty * $formattedPrice.'</span>
                    </div>
                </div>
                <div class="row cart-bottom-button ">
                    <button type="button" class="crt-Conti_but">Buy now</button>
                </div>
            </div>
        </div>
        <!------------>
        </div>
        
        ';
    }else{
        $output .= ' <!--------------------------------->
        <div class="row emptyrow m-0">
            <div class="col-md-12 empty-cart m-0">
                <div class="img-empty-cart"
                    style="background-image:url(&quot;'.MISCELLANEOUS.'empty-wishlist.svg&quot;);">
                </div>
                <h5>Your Cart is empty!</h5>
                <p>Explore more and add items to your cart.</p>
                <a class="empty-cart-a" href="'.BASEURL.'">CONTINUE SHOPPING</a>
            </div>
        </div>
        <!--------------------------------->';
    }

    return $output;
}

}

?>
